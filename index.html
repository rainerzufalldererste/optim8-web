<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Performance Analyzer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/png" href="/assets/favicon.png">
        <link rel="stylesheet" href="/assets/main.css">
    </head>
    <body>
        <div id="header">
            <img src="/assets/logo.png"/>
        </div>
        <div id="app_container">
            <script src="monaco-editor/min/vs/loader.js"></script>
            <div id="code_view" class="app_view"></div>
            <script type="module">
                var code_editor;
                var last_modification = Date.now();
                var sleep_time = 3000;
                var server_url = "http://localhost:61919/"

                function load_url(url, callback, obj) {
                  console.log('request: "' + url + '" with ' + obj);
                  var xmlhttp;
                  if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
                      xmlhttp = new XMLHttpRequest();
                  }
                  else { // code for IE6, IE5
                      xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                  }
                  xmlhttp.onreadystatechange = function() {
                      if (xmlhttp.readyState == 4 && xmlhttp.status >= 200 && xmlhttp.status < 300) {
                          callback(JSON.parse(xmlhttp.responseText));
                      }
                  }
                  xmlhttp.open("POST", url, true);
                  xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                  xmlhttp.send(JSON.stringify(obj));
                }

                function suggest_compile() {
                    if ((Date.now() - last_modification) >= sleep_time - 2) {
                        last_modification = Date.now();
                        var compiler = document.getElementById("compiler").value;
                        var opt = document.getElementById("opt_lvl").value;
                        var march = document.getElementById("march").value;
                        load_url(server_url + compiler, (e) => {
                            var compiler_out = e['compiler'];
                            var objdump_out = e['objdump'];
                            var asm = document.getElementById('asm');
                            var stdout = document.getElementById('stdout');

                            stdout.innerText = compiler_out;
                            asm.innerHTML = objdump_out.split('\n').join('<br>');
                        }, { 'opt': opt, 'march': march, 'src': code_editor.getValue() });
                    }
                }

                function content_changed() {
                    last_modification = Date.now();
                    setTimeout(suggest_compile, sleep_time);
                }

                require.config({ paths: { 'vs': 'monaco-editor/min/vs' }});
                require(['vs/editor/editor.main'], function() {
                    code_editor = monaco.editor.create(document.getElementById('code_view'), {
                        value: [
                            '#include <stdlib.h>',
                            '#include <stdint.h>',
                            '',
                            '#if defined(_MSC_VER) && !defined(__llvm__)',
                            '#include <intrin.h>',
                            '#else',
                            '#include <x86intrin.h>',
                            '#endif',
                            '',
                            'int32_t foo(const int32_t a)',
                            '{',
                            '  // what are we analzying today?',
                            '  return a * a;',
                            '}',
                        ].join('\n'),
                        language: 'cpp',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: {
                            enabled: false
                        },
                        padding: {
                          top: "15pt"
                        }
                    });

                    code_editor.getModel().onDidChangeContent(function(event) {
                        content_changed();
                    });
                });
            </script>
            <div class="h_separator"></div>
            <div id="disasm0" class="app_view disasm">
                <div class="selector">
                    <select id="compiler">
                      <optgroup label="GCC x64">
                        <option value="g++-x64-13">gcc 13</option>
                      </optgroup>
                      <optgroup label="Clang x64">
                        <option value="clang++-x64-16" selected="selected">clang 16</option>
                      </optgroup>
                    </select>
                    <select id="opt_lvl">
                        <option value="O0">-O0</option>
                        <option value="O1">-O1</option>
                        <option value="O2">-O2</option>
                        <option value="O3">-O3</option>
                        <option value="O4">-O4</option>
                        <option value="Of" selected="selected">-Ofast</option>
                        <option value="Os">-Os</option>
                        <option value="Oz">-Oz</option>
                        <option value="Og">-Og</option>
                    </select>
                    <select id="march">
                        <option value="none" selected="selected">none</option>
                      <optgroup label="Intel">
                        <option value="adl">Alderlake</option>
                        <option value="brw">Broadwell</option>
                        <option value="cnl">Cannonlake</option>
                        <option value="ccl">Cascadelake</option>
                        <option value="cpl">Cooperlake</option>
                        <option value="elr">EmeraldRapids</option>
                        <option value="gmt">Goldmont</option>
                        <option value="gmp">GoldmontPlus</option>
                        <option value="gdr">GrandRidge</option>
                        <option value="gtr">GraniteRapids</option>
                        <option value="hsw">Haswell</option>
                        <option value="ilc">IcelakeClient</option>
                        <option value="lcs">IcelakeServer</option>
                        <option value="ivb">IvyBridge</option>
                        <option value="mtl">Meteorlake</option>
                        <option value="rtl">Raptorlake</option>
                        <option value="rkl">Rocketlake</option>
                        <option value="sdb">Sandybridge</option>
                        <option value="spr">SapphireRapids</option>
                        <option value="srf">Sierraforest</option>
                        <option value="svm">Silvermont</option>
                        <option value="slc">SkylakeClient</option>
                        <option value="slx">SkylakeX</option>
                        <option value="sls">SkylakeServer</option>
                        <option value="tgl">Tigerlake</option>
                        <option value="trm">Tremont</option>
                      </optgroup>
                      <optgroup label="AMD">
                        <option value="zn1">Zen1</option>
                        <option value="zn2">Zen2</option>
                        <option value="zn3">Zen3</option>
                        <option value="zn4">Zen4</option>
                      </optgroup>
                    </select>
                    <label class="switch">
                      <input id="zydec" type="checkbox" checked="true">
                      <span class="slider"></span>
                    </label>
                </div>
                <div class="disasm" id="asm">
                    xor rax, rax<br>
                    ret
                </div>
                <div class="v_separator"></div>
                <div class="stdout" id="stdout">
                    Compiling...
                </div>
            </div>
        </div>
    </body>
</html>
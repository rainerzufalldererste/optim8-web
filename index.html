<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Performance Analyzer</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/png" href="/assets/favicon.png">
        <link rel="stylesheet" href="/assets/main.css">
    </head>
    <body>
        <div id="header">
            <img src="/assets/logo.png"/>
        </div>
        <div id="app_container">
            <script src="monaco-editor/min/vs/loader.js"></script>
            <div id="code_view" class="app_view"></div>
            <script type="module">
                var code_editor;
                var last_modification = Date.now();
                const sleep_time = 3000;
                const server_url = "http://localhost:61919/"
                var last_dump;

                function load_url(url, callback, obj) {
                  console.log('requesting "' + url + '" with ' + JSON.stringify(obj) + '.');
                  var xmlhttp;
                  if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
                      xmlhttp = new XMLHttpRequest();
                  }
                  else { // code for IE6, IE5
                      xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                  }
                  xmlhttp.onreadystatechange = function() {
                      if (xmlhttp.readyState == 4 && xmlhttp.status >= 200 && xmlhttp.status < 300) {
                          callback(JSON.parse(xmlhttp.responseText));
                      }
                  }
                  xmlhttp.open("POST", url, true);
                  xmlhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                  xmlhttp.send(JSON.stringify(obj));
                }

                function append_element(parent, type, className, innerText) {
                    const elem = document.createElement(type);
                    elem.innerText = innerText;
                    elem.className = className;
                    parent.appendChild(elem);
                    return elem;
                }

                function hexToBytes(hex) {
                    let bytes = [];

                    for (let i = 0; i < hex.length; i += 3)
                        bytes.push(parseInt(hex.substr(i, 2), 16));

                    return bytes;
                }

                function bytesToHex(byteArray) {
                  return Array.from(byteArray, function(byte) {
                    return ('0' + (byte & 0xFF).toString(16)).slice(-2);
                  }).join(' ');
                }

                function bytesToBase64(bytes) {
                    return window.btoa(String.fromCharCode.apply(null, new Uint8Array(bytes)));
                }

                function display_zydec() {
                    for (let i = 0; i < last_dump.length; i++)
                    {
                        let sym = last_dump[i];

                        for (let j = 0; j < sym.length; j++)
                        {
                            let data = sym[j];
                            let n = data.element;
                            n.innerHTML = "";

                            let sect = data.dec.split('// ');

                            append_element(n, 'b', 'addr dec', data.addr.toString(16));

                            var dec = append_element(n, 'b', 'dec', sect[0]);
                            dec.title = sect[2];

                            dec.innerHTML = dec.innerHTML.replaceAll('(m512)', '<i class="dectype">m512</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('(m256)', '<i class="dectype">m256</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('(m128)', '<i class="dectype">m128</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('(i64)', '<i class="dectype">i64</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('(i32)', '<i class="dectype">i32</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('(i16)', '<i class="dectype">i16</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('(i8)', '<i class="dectype">i8</i>')

                            dec.innerHTML = dec.innerHTML.replaceAll('extra_segment:', '<i class="decbuiltin">extra_segment:</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('code_segment:', '<i class="decbuiltin">code_segment:</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('stack_segment:', '<i class="decbuiltin">stack_segment:</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('data_segment:', '<i class="decbuiltin">data_segment:</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('f_segment:', '<i class="decbuiltin">f_segment:</i>')
                            dec.innerHTML = dec.innerHTML.replaceAll('g_segment:', '<i class="decbuiltin">g_segment:</i>')

                            dec.innerHTML = dec.innerHTML.replaceAll('compare(', '<i class="decbasic">compare</i>(')
                            dec.innerHTML = dec.innerHTML.replaceAll('if (', '<i class="decbasic">if</i> (')
                            dec.innerHTML = dec.innerHTML.replaceAll('goto ', '<i class="decbasic">goto</i> ')

                            if (sect.length > 1)
                                append_element(n, 'b', 'comment dec', "// " + sect[1]);

                            append_element(n, 'i', 'isa ' + data.isa, data.isa);
                        }
                    }
                }

                function load_zydec(dump_index) {
                    let bytes = [];
                    let func = last_dump[dump_index];
                    
                    for (let i = 0; i < func.length; i++)
                        bytes = bytes.concat(func[i].bytes);

                    const base64 = bytesToBase64(bytes);
                    const request = { 'bytes': base64, 'addr': func[0].addr };

                    load_url(server_url + 'zydec', (e) => {
                        let func = last_dump[dump_index];
                        let idx = 0;
                        let data = e.zydec.split('\n');

                        for (let i = 0; i < data.length; i++)
                        {
                            if (data[i] == '')
                                continue;

                            let sect = data[i].split('\t');
                            let addr = parseInt(sect[0]);

                            let n = func[idx];

                            if (n.addr == addr)
                            {
                                idx++;

                                n.rawZydec = data[i];
                                n.dec = sect[1];
                                n.isa = sect[2];
                            }
                        }

                        if (last_dump.length > dump_index + 1)
                            load_zydec(dump_index + 1);
                        else
                            display_zydec();
                    }, request);
                }

                function display_disasm() {
                    var asm = document.getElementById('asm');
                    asm.innerHTML = "";

                    for (let i = 0; i < last_dump.length; i++)
                    {
                        let sym = last_dump[i];

                        var container = append_element(asm, 'div', 'function');
                        sym.element = append_element(container, 'h3', 'symbol', sym.name);

                        for (let j = 0; j < sym.length; j++)
                        {
                            var e = append_element(container, 'p', 'asm_line', '');
                            e.origin = { 'sym': i, 'line': j, 'addr': sym[j].addr };
                            sym[j].element = e;
                            append_element(e, 'b', 'addr', sym[j].addrStr);
                            append_element(e, 'i', 'bytes', bytesToHex(sym[j].bytes));
                            append_element(e, 'b', sym[j].isJump ? 'jump' : 'mnemonic', sym[j].mnemonic);
                            var params = append_element(e, 'i', 'params', sym[j].params);
                            params.innerHTML = params.innerHTML.replaceAll(' ZMMWORD PTR ', ' <i class="ptr">ZMMWORD PTR </i> ')
                            params.innerHTML = params.innerHTML.replaceAll(' YMMWORD PTR ', ' <i class="ptr">YMMWORD PTR </i> ')
                            params.innerHTML = params.innerHTML.replaceAll(' XMMWORD PTR ', ' <i class="ptr">XMMWORD PTR </i> ')
                            params.innerHTML = params.innerHTML.replaceAll(' QWORD PTR ', ' <i class="ptr">QWORD PTR </i> ')
                            params.innerHTML = params.innerHTML.replaceAll(' DWORD PTR ', ' <i class="ptr">DWORD PTR </i> ')
                            params.innerHTML = params.innerHTML.replaceAll(' WORD PTR ', ' <i class="ptr">WORD PTR </i> ')
                            params.innerHTML = params.innerHTML.replaceAll(' BYTE PTR ', ' <i class="ptr">BYTE PTR </i> ')

                            if (sym[j].comment)
                                append_element(e, 'i', 'comment', sym[j].comment);
                        }
                    }
                }

                function suggest_compile() {
                    if ((Date.now() - last_modification) >= sleep_time - 2) {
                        last_dump = null;
                        last_modification = Date.now();
                        var compiler = document.getElementById("compiler").value;
                        var opt = document.getElementById("opt_lvl").value;
                        var march = document.getElementById("march").value;
                        load_url(server_url + compiler, (e) => {
                            var compiler_out = e['compiler'];
                            var objdump_out = e['objdump'];
                            var stdout = document.getElementById('stdout');

                            if (compiler_out == '')
                                compiler_out = "Success!";

                            stdout.innerText = compiler_out;
                            var dumplines = objdump_out.split('\n');
                            last_dump = [];
                            var last_sym = [];
                            var expect_symbol = true;
                            const jumps = ['jmp', 'jb', 'jbe', 'jcxz', 'je', 'jecxz', 'jl', 'jle', 'jnb', 'jnbe', 'jnl', 'jnle', 'jno', 'jnp', 'jns', 'jnz', 'jo', 'jp', 'js', 'jz'];

                            for (let i = 0; i < dumplines.length; i++)
                            {
                                let x = dumplines[i];

                                if (x == '')
                                {
                                    expect_symbol = true;
                                }
                                else if (expect_symbol)
                                {
                                    expect_symbol = false;
                                    last_sym = [];
                                    var prefix = x.split('<')[0];
                                    last_sym.name = x.substring(prefix.length);
                                    last_dump.push(last_sym);
                                }
                                else
                                {
                                    let trimmed = x.trim();
                                    let sect = x.split('\t');
                                    let addr = sect[0].replaceAll(':', '').trim(' ');
                                    const hex = sect[1].trim(' ');
                                    const bytes = hexToBytes(hex);
                                    const _asm = sect[2].trim(' ').replaceAll(',', ", ").replaceAll('  ', ' ');
                                    const mnemonic = _asm.split(' ')[0];
                                    const params = _asm.substring(mnemonic.length).trim();
                                    const beforeComment = params.split('#')[0];
                                    const comment = params.substring(beforeComment.length);
                                    const isJump = jumps.includes(mnemonic);
                                    var target;

                                    if (isJump)
                                        target = parseInt(beforeComment.split(' ')[0], 16);

                                    last_sym.push({ 'raw': x, 'addrStr': addr, 'addr': parseInt(addr, 16), 'bytes': bytes, 'asm': _asm, 'mnemonic': mnemonic, 'params': beforeComment, 'comment': comment, 'isJump': isJump, 'target': target });
                                }
                            }

                            display_disasm();

                            if (document.getElementById('zydec').checked)
                                load_zydec(0);

                        }, { 'opt': opt, 'march': march, 'src': code_editor.getValue() });
                    }
                }

                window.content_changed = function () {
                    document.getElementById('stdout').innerText = "Waiting for Compile...";
                    last_modification = Date.now();
                    setTimeout(suggest_compile, sleep_time);
                }

                window.zydec_changed = function() {
                    if (document.getElementById('zydec').checked)
                        display_zydec();
                    else
                        display_disasm();
                }

                require.config({ paths: { 'vs': 'monaco-editor/min/vs' }});
                require(['vs/editor/editor.main'], function() {
                    code_editor = monaco.editor.create(document.getElementById('code_view'), {
                        value: [
                            '#include <stdlib.h>',
                            '#include <stdint.h>',
                            '',
                            '#if defined(_MSC_VER) && !defined(__llvm__)',
                            '#include <intrin.h>',
                            '#else',
                            '#include <x86intrin.h>',
                            '#endif',
                            '',
                            'void merge_lines(const uint32_t *pSourceLine, const uint32_t *pSourceLine2, const size_t length, uint32_t *pTargetLine)',
                            '{',
                            '  // what are we analzying today?',
                            '  const __m128i lower7bits = _mm_set1_epi8(0b1111111);',
                            '  const __m128i oneA = _mm_set1_epi64x(0x0000010001010001LL);',
                            '  const __m128i oneB = _mm_set1_epi64x(0x0101000100000100LL);',
                            '',
                            '  constexpr size_t colorsPerVector = sizeof(__m128i) / sizeof(uint32_t);',
                            '',
                            '  for (size_t x = 0; x < length; x += 2)',
                            '  {',
                            '    // load two vectors from both lines of the source.',
                            '    const __m128i line00r = _mm_loadu_si128(reinterpret_cast<const __m128i *>(pSourceLine + x * 2));',
                            '    const __m128i line01r = _mm_loadu_si128(reinterpret_cast<const __m128i *>(pSourceLine + x * 2 + colorsPerVector));',
                            '    const __m128i line10r = _mm_loadu_si128(reinterpret_cast<const __m128i *>(pSourceLine2 + x * 2));',
                            '    const __m128i line11r = _mm_loadu_si128(reinterpret_cast<const __m128i *>(pSourceLine2 + x * 2 + colorsPerVector));',
                            '',
                            '    // dither with one (saturate to not accidentally cause an overflow with 0xFF) and divide by two.',
                            '    const __m128i line00 = _mm_and_si128(lower7bits, _mm_srli_epi32(_mm_adds_epu8(line00r, oneA), 1));',
                            '    const __m128i line01 = _mm_and_si128(lower7bits, _mm_srli_epi32(_mm_adds_epu8(line01r, oneB), 1));',
                            '    const __m128i line10 = _mm_and_si128(lower7bits, _mm_srli_epi32(_mm_adds_epu8(line10r, oneB), 1));',
                            '    const __m128i line11 = _mm_and_si128(lower7bits, _mm_srli_epi32(_mm_adds_epu8(line11r, oneA), 1));',
                            '',
                            '    // add, dither again and divide by two.',
                            '    const __m128i line_0 = _mm_and_si128(lower7bits, _mm_srli_epi32(_mm_adds_epu8(_mm_add_epi8(line00, line10), oneA), 1));',
                            '    const __m128i line_1 = _mm_and_si128(lower7bits, _mm_srli_epi32(_mm_adds_epu8(_mm_add_epi8(line01, line11), oneB), 1));',
                            '',
                            '    // shuffle the first and second color blocks into two separate vectors.',
                            '    const __m128i lo = _mm_castps_si128(_mm_shuffle_ps(_mm_castsi128_ps(line_0), _mm_castsi128_ps(line_1), _MM_SHUFFLE(2, 0, 2, 0)));',
                            '    const __m128i hi = _mm_castps_si128(_mm_shuffle_ps(_mm_castsi128_ps(line_0), _mm_castsi128_ps(line_1), _MM_SHUFFLE(3, 1, 3, 1)));',
                            '',
                            '    // add them.',
                            '    const __m128i merged = _mm_add_epi8(lo, hi);',
                            '',
                            '    _mm_store_si128(reinterpret_cast<__m128i *>(pTargetLine + x), merged);',
                            '  }',
                            '}',
                            ''
                        ].join('\n'),
                        language: 'cpp',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: {
                            enabled: false
                        },
                        padding: {
                          top: "15pt"
                        },
                        wordWrap: 'on'
                    });

                    code_editor.getModel().onDidChangeContent(function(event) {
                        content_changed();
                    });
                });
            </script>
            <div class="h_separator"></div>
            <div id="disasm0" class="app_view disasm">
                <div class="selector">
                    <select id="compiler" onchange="javascript:content_changed();">
                      <optgroup label="GCC x64">
                        <option value="g++-x64-13">gcc 13</option>
                      </optgroup>
                      <optgroup label="Clang x64">
                        <option value="clang++-x64-16" selected="selected">clang 16</option>
                      </optgroup>
                    </select>
                    <select id="opt_lvl" onchange="javascript:content_changed();">
                        <option value="O0">-O0</option>
                        <option value="O1">-O1</option>
                        <option value="O2">-O2</option>
                        <option value="O3">-O3</option>
                        <option value="O4">-O4</option>
                        <option value="Of" selected="selected">-Ofast</option>
                        <option value="Os">-Os</option>
                        <option value="Oz">-Oz</option>
                        <option value="Og">-Og</option>
                    </select>
                    <select id="march" onchange="javascript:content_changed();">
                        <option value="none" selected="selected">none</option>
                      <optgroup label="Intel">
                        <option value="adl">Alderlake</option>
                        <option value="brw">Broadwell</option>
                        <option value="cnl">Cannonlake</option>
                        <option value="ccl">Cascadelake</option>
                        <option value="cpl">Cooperlake</option>
                        <option value="elr">EmeraldRapids</option>
                        <option value="gmt">Goldmont</option>
                        <option value="gmp">GoldmontPlus</option>
                        <option value="gdr">GrandRidge</option>
                        <option value="gtr">GraniteRapids</option>
                        <option value="hsw">Haswell</option>
                        <option value="ilc">IcelakeClient</option>
                        <option value="lcs">IcelakeServer</option>
                        <option value="ivb">IvyBridge</option>
                        <option value="mtl">Meteorlake</option>
                        <option value="rtl">Raptorlake</option>
                        <option value="rkl">Rocketlake</option>
                        <option value="sdb">Sandybridge</option>
                        <option value="spr">SapphireRapids</option>
                        <option value="srf">Sierraforest</option>
                        <option value="svm">Silvermont</option>
                        <option value="slc">SkylakeClient</option>
                        <option value="slx">SkylakeX</option>
                        <option value="sls">SkylakeServer</option>
                        <option value="tgl">Tigerlake</option>
                        <option value="trm">Tremont</option>
                      </optgroup>
                      <optgroup label="AMD">
                        <option value="zn1">Zen1</option>
                        <option value="zn2">Zen2</option>
                        <option value="zn3">Zen3</option>
                        <option value="zn4">Zen4</option>
                      </optgroup>
                    </select>
                    <i class="label">decode</i>
                    <label class="switch">
                      <input id="zydec" type="checkbox" checked="true" onchange="javascript:zydec_changed();">
                      <span class="slider"></span>
                    </label>
                </div>
                <div class="disasm_container">
                    <div class="disasm" id="asm">
                        Edit or Paste Code To Begin Analyzing.
                    </div>
                </div>
                <div class="v_separator"></div>
                <div class="stdout" id="stdout">
                    Edit or Paste Code To Begin Analyzing.
                </div>
            </div>
        </div>
    </body>
</html>